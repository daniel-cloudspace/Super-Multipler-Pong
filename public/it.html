
<style type="text/css">
    #map { width:1000px; border: 5px solid black; height: 700px; }
    #map #left_field { float:left; width:49%; height: 100%; }
    #map #right_field { float:right; width:49%; height: 100%; border-left: 3px dotted gray; }
    .green_ponger { background-image: url('/images/greenpaddle.png'); }
    .red_ponger { background-image: url('/images/redpaddle.png'); }
</style>



<body>
    <div id="map">
        <div id="left_field">
        </div>
        <div id="right_field">
        </div>
    </div>
</body>


<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="keys.js"></script>
<script type="text/javascript">
function $(id) {
    return document.getElementById(id);
}
var sprites = {};
window.addEventListener('load', function()
{

    // Key stroke bindings
    document.addEventListener('keydown', function(e) {
        players[my_id].keystrokes[e.keyCode] = true;
            socket.send({
                'my_id': my_id, 
                'the_event': { 
                    x: players[my_id].x,
                    y: players[my_id].y,
                    keystrokes: players[my_id].keystrokes
                }
            });
            players[my_id].updated = false;
        players[my_id].updated = true;
        e.preventDefault();

    }, false);
    document.addEventListener('keyup', function(e) {
        players[my_id].keystrokes[e.keyCode] = false;
            socket.send({
                'my_id': my_id, 
                'the_event': { 
                    x: players[my_id].x,
                    y: players[my_id].y,
                    keystrokes: players[my_id].keystrokes
                }
            });
            players[my_id].updated = false;
        players[my_id].updated = true;
        e.preventDefault();
    }, false);
    document.addEventListener('keypress', function(e) {
        e.preventDefault();
    }, false);


    function create_new_ponger(id) {
        var pongerSprite = document.createElement('div');
        pongerSprite.id = 'ponger' + id;
        pongerSprite.className = ( Math.random() > 0.5 ? 'red_ponger' : 'green_ponger' );
        pongerSprite.style.position = 'absolute';
        pongerSprite.style.width = '10px';
        pongerSprite.style.height = '120px';
        
        var starter_x = ( Math.random() > 0.5 ? 100 : 500 );
        
        $('map').appendChild(pongerSprite);

        var keystrokes = {};
        keystrokes[DOM_VK.UP] = keystrokes[DOM_VK.DOWN] = keystrokes[DOM_VK.RIGHT] = keystrokes[DOM_VK.LEFT] = false;
        return { sprite: pongerSprite, player: { x: starter_x, y: 0, color: '#CCCCCC', updated: false, keystrokes: keystrokes} };
    }




    var my_id;
    var players = {};
    var sprites = {};
    var buffer = {};
    
    
    var socket = new io.Socket(null, {port: 8080, rememberTransport: false});

    socket.connect();

    socket.on('connect', function(){ return true; });

    socket.on('message', function(message) {
        // there has to be a better way to send initialization data
        if ( 'init_data' in message ) {
            my_id = message.init_data.your_id;
            var me = create_new_ponger(my_id);
            players[my_id] = me.player;
            sprites[my_id] = me.sprite;
        } else {
            for (var i in message) {
                // new player has entered the game
                if (typeof players[i] == "undefined") {
                    var new_ponger = create_new_ponger(i);
                    players[i] = new_ponger.player;
                    sprites[i] = new_ponger.sprite;
                } else {
                    if (i != my_id) {
                        players[i].x = message[i].x;
                        players[i].y = message[i].y;
                        players[i].keystrokes[DOM_VK.UP] = message.the_event.keystrokes[DOM_VK.UP];
                        players[i].keystrokes[DOM_VK.DOWN] = message.the_event.keystrokes[DOM_VK.DOWN];
                        players[i].keystrokes[DOM_VK.LEFT] = message.the_event.keystrokes[DOM_VK.LEFT];
                        players[i].keystrokes[DOM_VK.RIGHT] = message.the_event.keystrokes[DOM_VK.RIGHT];
                    }
                }
           }
        }
    });


    // Animation Loop!!!
    var ponger_step = 10;
    setInterval(function() {
        // animate all players according to their keystrokes
        for (i in players) {
            if (players[i].keystrokes[DOM_VK.UP])    { players[i].y -= ponger_step; }
            if (players[i].keystrokes[DOM_VK.DOWN])  { players[i].y += ponger_step; }
            if (players[i].keystrokes[DOM_VK.RIGHT]) { players[i].x += ponger_step; }
            if (players[i].keystrokes[DOM_VK.LEFT])  { players[i].x -= ponger_step; }
            
            sprites[i].style.marginLeft = players[i].x;
            sprites[i].style.marginTop = players[i].y;
        }

        // Update the server if there has been a change in the user.
/*        if (players[my_id].updated) {
            socket.send({
                'my_id': my_id, 
                'the_event': { 
                    x: players[my_id].x,
                    y: players[my_id].y,
                    keystrokes: players[my_id].keystrokes
                }
            });
            players[my_id].updated = false;
        }
*/
    }, 50);
/*    setInterval(function() {
        for (i in players) {
            sprites[i].style.backgroundColor = (players[i].x > half_window_width) ? '#DD3333' : '#33DD33';
        }
    }, 500);
*/
}, false);
</script>
