
<style type="text/css">
    #map { width:99%; border: 5px solid black; height: 98%;}
    #map #left_field { float:left; width:49%; height: 100%; }
    #map #right_field { float:right; width:49%; height: 100%; border-left: 3px dotted gray; }
</style>



<body>
    <div id="map">
        <div id="left_field">
        </div>
        <div id="right_field">
        </div>
    </div>
</body>


<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="keys.js"></script>
<script type="text/javascript">
function $(id) {
    return document.getElementById(id);
}
var sprites = {};
window.addEventListener('load', function()
{

    // Key stroke bindings
    var keys = {};
    document.addEventListener('keydown', function(e) {
            keys[e.keyCode] = true;
            pongers[my_id].changed = true;
    }, false);
    document.addEventListener('keyup', function(e) {
            keys[e.keyCode] = false;
            pongers[my_id].changed = true;
    }, false);
    document.addEventListener('keypress', function(e) {
            e.preventDefault();
    }, false);


    function create_new_ponger(id) {
        var pongerSpriteHTML = "<div id='ponger_" + id + "' style=\"position: absolute; width:10px; height:120px; background-color: #CCCCCC;\">&nbsp;</div>";
        var starter_x = ( Math.random() > 0.5 ? 100 : 500 );
        $('map').innerHTML += pongerSpriteHTML;
        return { sprite: $('ponger_' + id), ponger: { x: starter_x, y: 0, color: '#CCCCCC', changed: false } };
    }




    var my_id;
    var pongers = {};
    //var sprites = {};

 
    var socket = new io.Socket(null, {port: 80, rememberTransport: false});
    socket.connect();
    socket.on('connect', function(){ console.log('connected'); })
    socket.on('message', function(message) {
        // there has to be a better way to send initialization data
        if ( 'init_data' in message ) {
            my_id = message.init_data.your_id;
            console.log('init data - ' + message.init_data.your_id);
        } else {
            for (var i in message) {
                // new player has entered the game
                if (typeof pongers[i] == "undefined") {
                    var new_ponger = create_new_ponger(i);
                    pongers[i] = new_ponger.ponger;
                    sprites[i] = new_ponger.sprite;
                }
    
                // mark if changed
                if (pongers[i].x != message[i].x || pongers[i].y != message[i].y) {
                    pongers[i].changed = true; 
    
                    // change data
                    pongers[i].x = message[i].x;
                    pongers[i].y = message[i].y;
                }   
            }
        }
    });

    var ponger_step = 10;
    var half_window_width = window.innerWidth / 2;
    setInterval(function() {
        if (keys[DOM_VK.UP]) { pongers[my_id].y -= ponger_step; }
        if (keys[DOM_VK.DOWN]) { pongers[my_id].y += ponger_step; }
        if (keys[DOM_VK.RIGHT]) { pongers[my_id].x += ponger_step; }
        if (keys[DOM_VK.LEFT]) { pongers[my_id].x -= ponger_step; }
        
//        if ( typeof pongers[my_id] != 'undefined' && typeof pongers[my_id].x != 'undefined') {
//            console.log(pongers[my_id].x + "  " + pongers[my_id].y, sprites[my_id]);
//        }

        socket.send(pongers[my_id]);
        
        for (i in pongers) {
            if (pongers[i].changed) {
                pongers[i].changed = false;
                //sprites[i].style.marginLeft = pongers[i].x;
                //sprites[i].style.marginTop = pongers[i].y;
                var sprite = $('ponger_'+i);
                sprite.style.marginLeft = pongers[i].x;
                sprite.style.marginTop = pongers[i].y;
            }
        }
    }, 50);

    setInterval(function() {
        for (i in pongers) {
            sprites[i].style.backgroundColor = (pongers[i].x > half_window_width) ? '#DD3333' : '#33DD33';
        }
    }, 500);

}, false);
</script>
